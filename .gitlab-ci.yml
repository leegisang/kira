# KIRA GitLab CI/CD Pipeline
# macOS runnerì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤ (Apple ì½”ë“œ ì‚¬ì´ë‹ í•„ìš”)

stages:
  - build
  - deploy

variables:
  # Node.js ë²„ì „
  NODE_VERSION: "22"

# macOS ë¹Œë“œ ë° ë°°í¬
deploy:
  stage: deploy
  timeout: 2h  # Notarization ëŒ€ê¸° ì‹œê°„ ê³ ë ¤
  tags:
    - kira-tags  # KIRA ì „ìš© macOS runner

  only:
    - tags  # íƒœê·¸ê°€ pushë  ë•Œë§Œ ì‹¤í–‰ (ì˜ˆ: v0.9.16)

  before_script:
    # Load nvm (Node Version Manager)
    - export NVM_DIR="$HOME/.nvm"
    - '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'

    # Node.js í™˜ê²½ í™•ì¸
    - node --version
    - npm --version

    # Keychain unlock (ì½”ë“œ ì‚¬ì´ë‹ ë¹„ë°€ë²ˆí˜¸ íŒì—… ë°©ì§€)
    - security unlock-keychain -p "$KEYCHAIN_PASSWORD" ~/Library/Keychains/login.keychain-db
    - security set-keychain-settings -t 7200 ~/Library/Keychains/login.keychain-db

    # AWS CLI í™•ì¸
    - which aws || brew install awscli
    - aws --version

    # AWS ìê²© ì¦ëª… ì„¤ì • (GitLab Variablesì—ì„œ)
    - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
    - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
    - export AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION

    # Apple ì½”ë“œ ì‚¬ì´ë‹ í™˜ê²½ë³€ìˆ˜ ì„¤ì • (GitLab Variablesì—ì„œ)
    - export APPLE_ID=$APPLE_ID
    - export APPLE_APP_SPECIFIC_PASSWORD=$APPLE_APP_SPECIFIC_PASSWORD
    - export APPLE_TEAM_ID=$APPLE_TEAM_ID

    # ì¸ì¦ì„œ ì„¤ì • (base64 ì¸ì½”ë”©ëœ p12 íŒŒì¼)
    - export CSC_LINK=$CSC_LINK
    - export CSC_KEY_PASSWORD=$CSC_KEY_PASSWORD

    # Electron ì•± dependencies ì„¤ì¹˜
    - cd electron-app && npm ci && cd ..

    # VitePress dependencies ì„¤ì¹˜
    - cd vitepress-app && npm ci && cd ..

  script:
    # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ ë° ì ìš©
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ (v0.9.16 â†’ 0.9.16)
        VERSION=${CI_COMMIT_TAG#v}
        echo "ğŸ“¦ íƒœê·¸ ë²„ì „: $CI_COMMIT_TAG â†’ $VERSION"

        # Electron ì•± package.json ë²„ì „ ì—…ë°ì´íŠ¸
        cd electron-app
        npm version $VERSION --no-git-tag-version
        echo "   âœ… Electron ì•± ë²„ì „: $VERSION"
        cd ..

        # VitePress ë¬¸ì„œ ë²„ì „ ë§í¬ ì—…ë°ì´íŠ¸
        cd vitepress-app
        node scripts/sync-version.js
        echo "   âœ… VitePress ë¬¸ì„œ ë²„ì „ ë§í¬ ì—…ë°ì´íŠ¸: $VERSION"
        cd ..
      else
        echo "âŒ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. íƒœê·¸ pushê°€ í•„ìš”í•©ë‹ˆë‹¤."
        exit 1
      fi

    # deploy.sh ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ì‹¤í–‰
    - chmod +x deploy.sh
    - ./deploy.sh

  artifacts:
    paths:
      - electron-app/dist/*.dmg
      - electron-app/dist/*.zip
    expire_in: 30 days

  # ë¹Œë“œ ì„±ê³µ/ì‹¤íŒ¨ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  # after_script:
  #   - echo "Build completed for version $(node -p "require('./electron-app/package.json').version")"

# í…ŒìŠ¤íŠ¸ ë¹Œë“œ (ìˆ˜ë™, ë°°í¬ëŠ” í•˜ì§€ ì•ŠìŒ)
test_build:
  stage: build
  tags:
    - kira-tags
  when: manual
  only:
    - branches

  before_script:
    # Load nvm (Node Version Manager)
    - export NVM_DIR="$HOME/.nvm"
    - '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'

    # Node.js í™˜ê²½ í™•ì¸
    - node --version
    - npm --version

    # Electron ì•± dependencies ì„¤ì¹˜
    - cd electron-app && npm ci && cd ..

  script:
    - cd electron-app
    - npm run build  # ë¹Œë“œë§Œ ìˆ˜í–‰, S3 ì—…ë¡œë“œ ì•ˆí•¨

  artifacts:
    paths:
      - electron-app/dist/*.dmg
      - electron-app/dist/*.zip
    expire_in: 7 days
